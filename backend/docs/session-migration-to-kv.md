# セッション管理のD1からCloudflare KVへの移行

## 概要

ユーザーセッション管理をCloudflare D1データベースからCloudflare KVへ移行しました。この変更により、セッション検証の高速化とシステムの全体的なパフォーマンス向上を実現しました。

## 背景

以前は、セッション情報をD1データベースの`sessions`テーブルに保存していました。しかし、認証チェックは頻繁に発生する操作であり、D1のレイテンシがパフォーマンスのボトルネックになる可能性がありました。

## 移行内容

### 変更されたコンポーネント

1. **SessionService** (`backend/src/services/SessionService.ts`)
   - D1からKVへの完全な移行
   - KVのTTL機能を活用した自動期限切れ
   - ユーザーIDからセッション検索用のインデックス実装

2. **データベーススキーマ**
   - D1から`sessions`テーブルを削除
   - マイグレーション `0008_remove_sessions_table.sql` を追加

3. **テストインフラ**
   - テストヘルパーをKVベースに更新
   - モックKV実装を追加（テスト環境用）

4. **開発ツール**
   - `create-session.ts` スクリプトをKV対応に更新

5. **設定ファイル**
   - `wrangler.toml` にSESSIONS KVバインディングを追加

6. **ドキュメント**
   - アーキテクチャドキュメントを更新

## KVのデータ構造

### セッションキー

```
session:{token}
```

**値:**
```json
{
  "token": "セッショントークン",
  "user_id": "ユーザーID",
  "created_at": "作成日時（ISO 8601）",
  "expires_at": "有効期限（ISO 8601）"
}
```

**TTL:** 30日（自動削除）

### ユーザーインデックスキー

```
user_sessions:{user_id}
```

**値:**
```json
["token1", "token2", "token3"]
```

このインデックスにより、特定のユーザーの全セッションを効率的に管理できます。

## パフォーマンスメリット

### 1. レイテンシの削減

- **以前（D1）**: 数十ミリ秒のクエリレイテンシ
- **現在（KV）**: 数ミリ秒のエッジキャッシュアクセス

### 2. D1の負荷軽減

セッション検証をKVに移行することで、D1は以下の重要なデータに集中できます：
- ユーザープロファイル
- ログエントリ
- タグとメタデータ
- 画像メタデータ

### 3. グローバル分散

KVはCloudflareのエッジネットワーク全体に分散されており、ユーザーの地理的位置に関係なく高速なアクセスが可能です。

### 4. 自動メンテナンス

KVのTTL機能により、期限切れセッションは自動的に削除されます。以前は`cleanupExpiredSessions`メソッドで手動クリーンアップが必要でしたが、現在は不要です。

## 移行手順（デプロイ時）

### 開発環境

1. ローカルKV名前空間は自動的に作成されます
2. マイグレーションを実行: `npm run db:migrate`
3. 開発サーバーを起動: `npm run dev`

### 本番環境

1. Cloudflare DashboardまたはWrangler CLIでKV名前空間を作成
2. `wrangler.toml`の`env.production.kv_namespaces`セクションで実際のIDを設定
3. マイグレーションをデプロイ
4. Workersをデプロイ

**注意:** マイグレーションにより既存のセッションはすべて無効になります。ユーザーは再ログインが必要になります。

## 後方互換性

### テスト環境

`SESSIONS` KVバインディングが提供されていない場合、システムは自動的にメモリベースのモックKVにフォールバックします。これにより、古いテストやローカル開発環境でも動作が保証されます。

### セッショントークン形式

セッショントークンの形式は変更されていません。既存のCookie処理、ヘッダー処理も引き続き動作します。

## テスト結果

- **全テスト成功**: 293/293 テスト ✅
- **Lintチェック**: 合格 ✅
- **ビルド**: 成功 ✅

## 今後の改善案

1. **セッション分析**: KVアクセスログを使用したセッション利用パターンの分析
2. **マルチリージョン最適化**: ユーザーの地理的位置に基づいたさらなる最適化
3. **JWT移行検討**: 検証可能なトークン（JWT）への移行を検討（KVアクセスすら不要になる可能性）

## 関連ドキュメント

- [Architecture Documentation](../../docs/architecture.md)
- [Cloudflare KV Documentation](https://developers.cloudflare.com/kv/)
- [Session Service Implementation](../src/services/SessionService.ts)
