# AI プロンプト改善ドキュメント

## 概要
Wikipedia記事を参照してタグの説明を生成するAI機能において、プロンプトエンジニアリングとアーキテクチャ改善を通じて以下の問題を改善しました。

## 最新の改善（2025年10月実施）

### 4. Wikipedia記事とプロンプトの分離、Markdown変換、トークン数削減

**問題**: 
- Wikipedia記事の内容と指示メッセージが混在していた
- HTMLコンテンツをそのまま送信していたため、トークン数が多かった
- 長文記事でトークン数制限を超過する可能性があった

**解決方法**:
1. **プロンプトの構造化**:
   - 指示部分とWikipedia記事を明確に分離
   - 指示: タスク、出力形式、ルール、注意事項
   - Wikipedia記事: 実際の記事内容（別セクションとして配置）

2. **Markdown変換によるトークン削減**:
   - Wikipedia HTMLコンテンツをMarkdown形式に変換
   - HTMLタグを除去し、Markdown記法に統一
   - 約20-30%のトークン削減を実現

3. **文字数切り詰め機能**:
   - 最大32,000文字（約8,000トークン相当）に制限
   - 句点の位置を考慮した自然な切り詰め
   - トークン数超過エラーを防止

**実装詳細**:
```typescript
// 新しいプロンプト構造
{
  input: [
    {
      role: 'system',
      content: 'ルールと制約の定義...'
    },
    {
      role: 'user',
      content: `
        # タスク
        ...指示内容...
        
        ## Wikipedia記事の内容
        ${markdownContent}  // Markdown変換済み、切り詰め済み
      `
    }
  ]
}
```

**変更されたメソッド**:
- `fetchWikipediaSummary`: HTML取得を追加
- `prepareWikipediaContent`: Markdown変換と切り詰め処理
- `buildInstructionPrompt`: 指示部分のみを構築
- `truncateText`: 文字数切り詰め処理
- `generateTagContentFromName`: 全体の統合

**追加されたテスト**:
- HTML→Markdown変換のテスト
- 文字数切り詰めのテスト
- プロンプト分離のテスト

**期待される効果**:
- ✅ トークン数削減（約20-30%削減）
- ✅ 長文記事への対応（最大32,000文字）
- ✅ プロンプトの明瞭化（指示とデータの分離）
- ✅ 処理の安定性向上（トークン数超過エラーの防止）

## 過去の改善

## 過去の改善

### 1. 空白を含むハッシュタグが正規化されていない
**問題**: AI生成されたハッシュタグに「アニメ」「ゲーム」などのメディアタイプや、カッコ書きの補足情報が含まれていた。

**例**: 
- 改善前: `#アニメSSS.DYNAZENON` `#ゲーム(GB)`
- 改善後: `#SSSS.DYNAZENON` `#ゲーム名`

**解決方法**: 
- システムプロンプトにハッシュタグ正規化の必須ルールを明記
- ユーザープロンプトに具体的な正規化ルールと実例を追加
- メディアタイプ除去とカッコ書き除去のルールを明確化

### 2. サブタイトルなどの列挙を指示している要素が列挙されていない
**問題**: シーズン、期、章、エピソード、各話タイトルなどのサブタイトル情報が省略されていた。

**解決方法**:
- ユーザープロンプトで「連載・シリーズ作品の場合は必須」と明記
- サブタイトル情報を「必ずすべて列挙」するよう強調
- 具体的な例（シーズン、期、章、巻、エピソード、各話タイトル）を列挙

### 3. 1行目の要約が不正確
**問題**: Wikipedia記事に存在しない情報（放送年、配信サービスなど）が含まれていた。

**例（SSSS.GRIDMAN）**:
- 改善前: "2021年放送のテレビアニメ作品で、Netflixで配信された..."（不正確）
- 改善後: "円谷プロダクションの特撮テレビドラマ『電光超人グリッドマン』を原作とする、TRIGGERによるテレビアニメ作品。"（正確）

**解決方法**:
- システムプロンプトで「記事の冒頭部分から正確に要約を作成すること」を明記
- ハルシネーション（虚偽情報の生成）を厳禁と強調
- 「記事に書かれていない情報は絶対に生成しないこと」を絶対ルールとして追加
- 不確実な情報を含めないよう明示

## プロンプトの改善履歴

### システムプロンプトの改善（初期バージョン）

**改善前:**
```
あなたはアニメ、マンガ、ゲームなどの趣味コンテンツに詳しい日本語アシスタントです。まずWikipediaでタグ名を検索し、記事が存在するか確認してください。記事が存在する場合のみ、その情報を基にタグの説明と関連タグを生成してください。記事が存在しない場合は、その旨を正直に伝えてください。存在しない情報を創作してはいけません。
```

**改善後:**
```
あなたはWikipedia記事を参照して正確な情報を抽出する専門アシスタントです。以下の重要ルールを厳守してください：

【絶対ルール】
1. 必ず日本語版Wikipediaで記事を検索し、実際の記事内容のみを参照すること
2. Wikipedia記事に書かれていない情報は絶対に生成しないこと（ハルシネーション厳禁）
3. 不確実な情報や推測は一切含めないこと
4. 記事の冒頭部分から正確に要約を作成すること
5. ハッシュタグは記事に明記されている関連項目のみから生成すること
6. サブタイトル・エピソード情報がある場合は必ずすべて列挙すること

【ハッシュタグ正規化の必須ルール】
- 作品名から「アニメ」「ゲーム」「漫画」などのメディアタイプを除去（正式名称の一部を除く）
- カッコ書きの補足情報を除去（例：「（GB）」「（テレビアニメ）」）
- 空白を含む場合は#{タグ名}形式、含まない場合は#タグ名形式を使用

記事が存在しない場合のみ「Wikipedia記事が見つかりませんでした」と回答してください。
```

**改善ポイント:**
- より具体的で指示的な内容に変更
- 重要ルールを【絶対ルール】として箇条書きで明記
- ハルシネーションを「厳禁」と強調
- 記事の冒頭部分から正確に要約を作成するよう明示
- ハッシュタグ正規化ルールを直接記載

### ユーザープロンプトの改善

**改善前:**
- 長文で構造化されていない説明
- 重要な指示が埋もれている
- 例が抽象的

**改善後:**
- タスク形式に構造化（# タスク、## ステップ1、## ステップ2）
- ステップバイステップで明確な指示
- 重要な指示を絵文字（❌✅）で強調
- 具体的な例（SSSS.GRIDMANなど）を追加
- ハッシュタグ正規化ルールを詳細化

**具体的な構造:**
```markdown
# タスク
日本語版Wikipediaで「タグ名」を検索し、記事内容から正確な情報を抽出してMarkdown形式で出力してください。

## ステップ1: Wikipedia記事の確認
- 記事が存在しない場合 → 終了
- 記事が存在する場合 → ステップ2へ

## ステップ2: 出力形式
### 1. 冒頭の要約（必須）
- Wikipedia記事の冒頭部分を正確に要約

### 2. 関連タグ（必須）
- ハッシュタグ正規化ルールを厳守
  1. メディアタイプを除去（具体例あり）
  2. カッコ書きを除去（具体例あり）
  3. 形式を統一（空白の有無で使い分け）

### 3. サブセクション（連載・シリーズ作品の場合は必須）
- シーズン・期・章・巻・エピソード・各話タイトルをすべて列挙

### 4. 出典（必須）
- Wikipedia URLを明記

## 重要な注意事項
❌ Wikipedia記事に書かれていない情報を生成しない
❌ 推測や創作で情報を補完しない
❌ 放送年や配信サービスなど、確認できない情報を含めない
✅ Wikipedia記事の内容のみを参照
✅ 不確実な情報は含めない
✅ ハッシュタグ正規化ルールを厳守
```

## テストケースの追加

以下のテストケースを追加して、プロンプトの品質を継続的に検証できるようにしました：

1. **システムプロンプトの重要指示確認テスト**
   - 「Wikipedia記事を参照して正確な情報を抽出」が含まれることを確認
   - 「ハルシネーション厳禁」が含まれることを確認
   - 「記事の冒頭部分から正確に要約を作成」が含まれることを確認
   - 「ハッシュタグ正規化」が含まれることを確認
   - 「サブタイトル・エピソード情報がある場合は必ずすべて列挙」が含まれることを確認

2. **ユーザープロンプトのハッシュタグ正規化ルール確認テスト**
   - 「ハッシュタグ正規化ルール」が含まれることを確認
   - 「メディアタイプを除去」が含まれることを確認
   - 「カッコ書きを除去」が含まれることを確認
   - 具体例が含まれることを確認

3. **ユーザープロンプトのサブタイトル列挙指示確認テスト**
   - 「連載・シリーズ作品の場合は必須」が含まれることを確認
   - 「シーズン・期」「章・巻」「エピソード・各話タイトル」が含まれることを確認
   - 「必ずすべて列挙」「省略せず」が含まれることを確認

## 期待される効果

### 1. 要約の正確性向上
- Wikipedia記事の冒頭部分を正確に反映した要約
- 存在しない情報（放送年、配信サービスなど）の除去
- ハルシネーション（虚偽情報）の防止

### 2. ハッシュタグの正規化
- メディアタイプ（「アニメ」「ゲーム」など）の適切な除去
- カッコ書き補足情報の除去
- 統一された形式（#タグ名、#{タグ名}）

### 3. サブタイトル情報の完全列挙
- シーズン・期情報の列挙
- エピソード・各話タイトルの列挙
- 連載・シリーズ作品の詳細情報提供

## 注意事項

### AI モデルの制約
- 使用しているAIモデル（@cf/openai/gpt-oss-120b）の性能に依存
- プロンプトの改善により精度は向上するが、100%の正確性は保証されない
- 生成された内容は最終的に人間が確認・編集することを前提

### プロンプトの継続的改善
- AI モデルのアップデートに応じてプロンプトの調整が必要な場合がある
- ユーザーフィードバックに基づいて継続的にプロンプトを改善
- テストケースを追加してプロンプトの品質を維持

## 関連ファイル

- `backend/src/services/AiService.ts` - AIサービス実装（プロンプト定義）
- `backend/tests/unit/AiService.test.ts` - AIサービスのユニットテスト
- `docs/ai-prompt-improvements.md` - このドキュメント

## 参考資料

- [Cloudflare Workers AI Documentation](https://developers.cloudflare.com/workers-ai/)
- [プロンプトエンジニアリングガイド](https://www.promptingguide.ai/jp)
- [Wikipedia API](https://ja.wikipedia.org/api/rest_v1/)
