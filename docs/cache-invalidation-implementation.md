# キャッシュ無効化の実装

## 概要

コンテンツ更新時にキャッシュが適切に無効化されるようにし、更新したユーザーに最新のコンテンツが確実に表示されるようにしました。

## 実装内容

### 1. キャッシュ無効化ヘルパー関数の追加

`backend/src/middleware/cache.ts` に `invalidateCache()` 関数を追加しました。

**機能:**
- 指定されたURLのキャッシュを Cloudflare Cache API から削除
- 相対パスと完全なURLの両方に対応
- テスト環境での安全な動作（Cache APIが利用できない場合はスキップ）
- エラー時も処理を継続（キャッシュ削除失敗時もレスポンスは正常に返る）

### 2. ログ更新時のキャッシュ無効化

以下のエンドポイントでキャッシュ無効化を実装しました：

#### PUT /logs/:logId（ログ更新）

更新されたログのキャッシュを削除：
- `/logs/:logId` のキャッシュを削除
- `/api/logs/:logId` のキャッシュを削除（APIプレフィックス付き）
- 公開ログの場合、一覧のキャッシュも削除：
  - `/logs` のキャッシュを削除
  - `/api/logs` のキャッシュを削除

#### POST /logs（ログ作成）

新しい公開ログを作成した場合、一覧のキャッシュを削除：
- `/logs` のキャッシュを削除
- `/api/logs` のキャッシュを削除

非公開ログの場合はキャッシュ削除不要（そもそもキャッシュされない）

#### DELETE /logs/:logId（ログ削除）

削除されたログのキャッシュを削除：
- `/logs/:logId` のキャッシュを削除
- `/api/logs/:logId` のキャッシュを削除
- 公開ログだった場合、一覧のキャッシュも削除：
  - `/logs` のキャッシュを削除
  - `/api/logs` のキャッシュを削除

### 3. テストの追加

`backend/tests/contract/cache-invalidation.test.ts` を追加し、以下のシナリオを検証：

1. **ログ更新後の即時反映**: ログを更新した後、認証なしのGETリクエストでも最新の内容が取得できることを確認
2. **ログ作成後の一覧反映**: 新しい公開ログを作成した後、一覧に含まれることを確認
3. **ログ削除後の一覧更新**: ログを削除した後、一覧から削除されることを確認
4. **非公開ログのキャッシュ動作**: 非公開ログの更新時のキャッシュ動作を確認

## 動作の流れ

### ログ更新時の例

```
1. ユーザーがログを更新（PUT /logs/:logId）
   ↓
2. ログサービスでデータベースを更新
   ↓
3. invalidateCache() でキャッシュを削除：
   - /logs/:logId のキャッシュ削除
   - /api/logs/:logId のキャッシュ削除
   - 公開ログの場合：
     - /logs のキャッシュ削除
     - /api/logs のキャッシュ削除
   ↓
4. 更新されたログデータを返す
   ↓
5. 次回のGETリクエスト時：
   - キャッシュミス（キャッシュが削除されたため）
   - データベースから最新データを取得
   - 新しいキャッシュを作成
```

## キャッシュ無効化の対象

### 必ず無効化されるもの

- **ログ詳細**: `/logs/:logId` と `/api/logs/:logId`
  - 更新、削除時に無効化

### 条件付きで無効化されるもの

- **ログ一覧**: `/logs` と `/api/logs`
  - 公開ログの作成、更新、削除時に無効化
  - 非公開ログの場合は無効化しない（公開一覧に影響しないため）

## 設計の考慮点

### 1. 両方のパスを無効化する理由

アプリケーションは `/api` プレフィックス付きとなしの両方のパスでアクセス可能なため、両方のキャッシュを削除する必要があります。

### 2. 非公開ログの扱い

非公開ログは：
- そもそも認証なしではキャッシュされない（cacheApi ミドルウェアで除外）
- 公開一覧に含まれない
- したがって、非公開ログの更新時は一覧のキャッシュ削除は不要

### 3. エラーハンドリング

キャッシュ削除に失敗してもレスポンスは正常に返されます。これにより：
- ユーザー体験を損なわない
- Cache API が利用できない環境（テスト環境など）でも動作する
- キャッシュ削除の失敗がサービスの可用性に影響しない

## テスト結果

全テストが成功しています：

```
✓ ログを更新した後、最新の内容が表示される
✓ ログを作成した後、一覧に最新のログが表示される
✓ ログを削除した後、一覧から削除される
✓ 非公開ログを更新してもキャッシュに影響しない

Test Files  31 passed | 26 skipped (57)
Tests       272 passed | 59 skipped (331)
```

## 今後の拡張可能性

必要に応じて以下の拡張が可能です：

1. **タグ関連のキャッシュ無効化**: タグを更新した際に、関連するログのキャッシュも無効化
2. **パターンマッチング**: ワイルドカードを使った複数URLの一括削除
3. **キャッシュ無効化のログ**: 無効化操作の詳細なログ記録
4. **キャッシュ無効化の統計**: どのエンドポイントがどの程度無効化されているかの監視

## 参考資料

- [Cloudflare Workers Cache API](https://developers.cloudflare.com/workers/runtime-apis/cache/)
- [Cache API delete method](https://developer.mozilla.org/en-US/docs/Web/API/Cache/delete)
