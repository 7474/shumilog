# タグ選択の利便性向上 - 設計書

## 課題

現在のshumilogでは、階層的なタグ（例：「進撃の巨人」→「第1話」、「任天堂」→「Switch」）を使ったログ作成が直感的ではありません。

具体的な課題：
- 作品の特定エピソード（例：「進撃の巨人 第5話」）のログを作成する際、毎回手動でハッシュタグを入力する必要がある
- 商品ブランドの特定製品（例：「任天堋 Switch」）のログを作成する際、関連タグが見つけにくい
- タグの階層関係（親子関係）は存在するが、ログ作成時にその関係を活用できていない

## ユースケース

### UC1: 作品のエピソード記録
**アクター**: shumilogユーザー（アニメ視聴者）

**前提条件**:
- ユーザーは「進撃の巨人」というタグを既に使用したことがある
- または、「進撃の巨人」タグに「第1話」「第2話」などの関連タグが設定されている

**フロー**:
1. ユーザーがログ作成画面を開く
2. 内容欄に「#進撃の巨人」と入力し始める
3. システムが「進撃の巨人」タグを候補として表示
4. ユーザーが「進撃の巨人」タグを選択
5. システムが関連タグ（「第1話」「第2話」「第3話」...）を自動的に候補として表示
6. ユーザーが「第5話」を選択
7. 内容欄に「#進撃の巨人 #{第5話}」が自動挿入される
8. ユーザーが追加の内容を記述してログを保存

**期待される結果**:
- 3クリック程度でエピソード記録が完了
- 手動でのハッシュタグ入力が不要
- タグの一貫性が保たれる

### UC2: 商品ブランドの製品記録
**アクター**: shumilogユーザー（ガジェット愛好家）

**前提条件**:
- 「任天堂」タグに「Switch」「3DS」などの製品タグが関連付けられている

**フロー**:
1. ユーザーがログ作成画面を開く
2. 内容欄に「#任天堂」と入力し始める
3. システムが「任天堂」タグを候補として表示
4. ユーザーが「任天堂」タグを選択
5. システムが関連タグ（「Switch」「3DS」など）を候補として表示
6. ユーザーが「Switch」を選択
7. さらに具体的な製品名を追加入力

**期待される結果**:
- ブランドと製品の階層を意識した記録が可能
- 過去の記録と一貫性のあるタグ付け

### UC3: 最近使用したタグからの選択
**アクター**: shumilogユーザー（継続記録者）

**前提条件**:
- ユーザーが過去に複数のタグを使用している

**フロー**:
1. ユーザーがログ作成画面を開く
2. タグ入力欄をクリック（またはフォーカス）
3. システムが最近使用したタグTop 10を表示
4. ユーザーが該当のタグを選択
5. 追加の内容を記述してログを保存

**期待される結果**:
- 継続的な記録活動で頻繁に使うタグに素早くアクセス
- タグ検索の手間を削減

### UC4: タグ詳細ページからのログ作成
**アクター**: shumilogユーザー（作品・商品の記録者）

**前提条件**:
- ユーザーが特定のタグの詳細ページを閲覧している
- そのタグに関連タグが設定されている（例：「進撃の巨人」に「第1話」「第2話」...が関連付けられている）

**フロー**:
1. ユーザーがタグ詳細ページ（例：「進撃の巨人」）を閲覧
2. ページ上部の「このタグでログを作成」ボタンをクリック
3. システムがログ作成フォームを表示、内容欄に親タグ（「#進撃の巨人」）が自動挿入される
4. システムが関連タグ（「第1話」「第2話」「第3話」...）を候補として自動表示
5. ユーザーが候補から「第5話」を選択
6. 内容欄が「#進撃の巨人 #{第5話} 」に更新される
7. ユーザーが感想や詳細を記述してログを保存

**期待される結果**:
- タグ閲覧からログ作成への自然な導線
- 親タグが自動挿入されるため入力の手間が削減
- 関連タグが即座に候補表示され、エピソード選択が容易
- 2クリック程度でエピソード指定まで完了

**バリエーション**:
- **関連タグから直接作成**: 関連タグ一覧で「第5話」タグをクリック時に「このタグでログを作成」オプションを表示
  - 親タグと子タグの両方が自動挿入される（「#進撃の巨人 #{第5話}」）
  - 1クリックでエピソード指定が完了

## 提案する設計

### 1. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────┐
│                  Frontend (React)                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │        TagDetailPage コンポーネント               │  │
│  │  - 関連タグ一覧表示                               │  │
│  │  - 「このタグでログを作成」ボタン                 │  │
│  │  - 関連タグから直接作成機能                       │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │          LogForm コンポーネント                    │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │  TagAutocomplete コンポーネント              │  │  │
│  │  │  - テキスト入力監視                          │  │  │
│  │  │  - ハッシュタグ検出                          │  │  │
│  │  │  - 候補表示                                  │  │  │
│  │  │  - 選択時の自動挿入                          │  │  │
│  │  │  - 初期値として親タグ自動挿入                │  │  │
│  │  │  - 関連タグの即座表示                        │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                           │ API呼び出し
                           ▼
┌─────────────────────────────────────────────────────────┐
│               Backend (Cloudflare Workers)               │
│  ┌──────────────────────────────────────────────────┐  │
│  │  GET /api/tags/suggestions?q={query}&limit={n}   │  │
│  │  → TagService.getTagSuggestions()                │  │
│  │     - FTS5全文検索でタグを検索                   │  │
│  │     - 使用頻度順でソート                         │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  GET /api/users/me/recent-tags?limit={n}         │  │
│  │  → TagService.getRecentTagsForUser()             │  │
│  │     - ユーザーの最近使用したタグを取得           │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  GET /api/tags/{tagName}/associations            │  │
│  │  → TagService.getTagAssociations()               │  │
│  │     - 指定タグの関連タグを取得                   │  │
│  │     - 既存のエンドポイント（拡張なし）           │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Database (D1/SQLite)                    │
│  - tags: タグマスタ                                      │
│  - tag_associations: タグ間の関連（親子関係）            │
│  - log_tag_associations: ログとタグの紐付け              │
│  - tags_fts: FTS5全文検索インデックス                   │
└─────────────────────────────────────────────────────────┘
```

### 2. UIコンポーネント設計

#### 2.1 TagAutocomplete コンポーネント

**責務**:
- テキストエリア内のカーソル位置を監視
- ハッシュタグパターン（`#` または `#{`）を検出
- API呼び出しでタグ候補を取得
- ドロップダウンで候補を表示
- 選択時にテキストエリアに挿入

**Props**:
```typescript
interface TagAutocompleteProps {
  value: string;                    // テキストエリアの現在値
  onChange: (value: string) => void; // 値変更時のコールバック
  onSelect?: (tag: Tag) => void;    // タグ選択時のコールバック
  placeholder?: string;
  className?: string;
}
```

**状態管理**:
```typescript
interface TagAutocompleteState {
  suggestions: Tag[];           // 候補タグリスト
  showSuggestions: boolean;     // 候補表示フラグ
  selectedIndex: number;        // キーボード選択インデックス
  currentHashtag: string | null; // 現在入力中のハッシュタグ
  cursorPosition: number;       // カーソル位置
  suggestionsType: 'search' | 'related' | 'recent'; // 候補タイプ
}
```

**候補表示のトリガー**:
1. **ハッシュタグ入力検出**: `#` または `#{` をタイプした時
2. **検索候補**: ユーザーが1文字以上入力した時
3. **関連タグ候補**: タグを選択した直後（自動的に表示）
4. **最近使用タグ**: 空のハッシュタグで `#` をタイプした時

**候補表示の優先順位**:
1. 関連タグ（親タグを選択した直後）
2. 最近使用したタグ
3. 検索結果（使用頻度順）

#### 2.2 LogForm の変更

**現在**:
```tsx
<Textarea
  placeholder="趣味の体験を詳しく記録しましょう..."
  {...field}
/>
```

**変更後**:
```tsx
<TagAutocomplete
  value={field.value}
  onChange={field.onChange}
  placeholder="趣味の体験を詳しく記録しましょう... (#タグ名 で候補表示)"
  onSelect={(tag) => {
    // タグ選択時に関連タグをロード
    loadRelatedTags(tag.id);
  }}
/>
```

#### 2.3 TagDetailPage の拡張

**現在の機能**:
- タグの説明表示
- 関連タグ一覧表示（リンクのみ）
- 新着ログ一覧表示
- 「このタグでログを作成」ボタン（既存）

**拡張内容**:

1. **ログ作成フォームの改善**
   - 「このタグでログを作成」ボタンをクリック時、LogFormに親タグを自動挿入
   - 関連タグが存在する場合、候補を即座に表示
   
2. **関連タグからの直接作成**
   - 各関連タグにホバー時、「このタグでログを作成」アイコンを表示
   - クリックで親タグ + 選択した関連タグの両方を自動挿入
   
**実装例**:
```tsx
// TagDetailPage内のログ作成処理
const handleCreateLogWithTag = (parentTag: Tag, childTag?: Tag) => {
  let initialContent = formatTagHashtag(parentTag.name);
  
  if (childTag) {
    // 関連タグからの作成の場合、両方を挿入
    initialContent += ` ${formatTagHashtag(childTag.name)}`;
  }
  
  setInitialLogContent(initialContent);
  setShowLogForm(true);
  
  // 関連タグを候補として事前ロード（子タグ未選択の場合）
  if (!childTag && tag.associated_tags?.length > 0) {
    setRelatedTagSuggestions(tag.associated_tags);
  }
};
```

**UIの改善**:
```tsx
{/* 関連タグ一覧 - 拡張版 */}
{tag.associated_tags && tag.associated_tags.length > 0 && (
  <div className="border-t border-gray-100 pt-4">
    <h3 className="text-sm font-semibold text-gray-700 mb-2">🔗 関連タグ</h3>
    <div className="flex flex-wrap gap-2">
      {tag.associated_tags.map((associatedTag) => (
        <div key={associatedTag.id} className="group relative">
          <Link to={`/tags/${encodeURIComponent(associatedTag.name)}`}>
            <span className="inline-flex items-center space-x-1 px-3 py-1 bg-sky-50 text-sky-700 rounded-full text-sm hover:bg-sky-100 transition-colors cursor-pointer">
              <span className="w-2 h-2 rounded-full bg-sky-400"></span>
              <span>{associatedTag.name}</span>
            </span>
          </Link>
          {/* ホバー時に表示: このタグでログを作成 */}
          {isAuthenticated && (
            <button
              onClick={(e) => {
                e.preventDefault();
                handleCreateLogWithTag(tag, associatedTag);
              }}
              className="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-fresh-500 text-white rounded-full p-1 shadow-lg hover:bg-fresh-600"
              title="このタグでログを作成"
            >
              <PenLine size={12} />
            </button>
          )}
        </div>
      ))}
    </div>
  </div>
)}
```

### 3. バックエンドAPI設計

#### 3.1 タグ候補取得API

**エンドポイント**: `GET /api/tags/suggestions`

**パラメータ**:
- `q` (required): 検索クエリ（1文字以上）
- `limit` (optional): 最大取得件数（デフォルト: 5、最大: 20）

**レスポンス**:
```json
[
  {
    "id": "tag-uuid-1",
    "name": "進撃の巨人",
    "description": "人気アニメシリーズ",
    "created_at": "2025-01-01T00:00:00Z",
    "usage_count": 42
  },
  {
    "id": "tag-uuid-2",
    "name": "進撃の巨人 第1話",
    "description": "",
    "created_at": "2025-01-05T00:00:00Z",
    "usage_count": 5
  }
]
```

**実装**:
- 既存の `TagService.getTagSuggestions()` を使用
- FTS5全文検索で高速検索
- 使用頻度（log_tag_associations の COUNT）でソート

#### 3.2 最近使用タグ取得API

**エンドポイント**: `GET /api/users/me/recent-tags`

**パラメータ**:
- `limit` (optional): 最大取得件数（デフォルト: 10、最大: 50）

**レスポンス**:
```json
[
  {
    "id": "tag-uuid-1",
    "name": "進撃の巨人",
    "description": "人気アニメシリーズ",
    "created_at": "2025-01-01T00:00:00Z",
    "last_used": "2025-10-13T10:30:00Z"
  }
]
```

**実装**:
- 既存の `TagService.getRecentTagsForUser()` を使用
- ログの作成日時でソート

#### 3.3 関連タグ取得API

**エンドポイント**: `GET /api/tags/{tagName}/associations`

**既存エンドポイント**: 変更不要
- tag_associations テーブルから関連タグを取得
- association_order でソート可能

### 4. データモデル

既存のスキーマをそのまま活用：

```sql
-- タグマスタ
CREATE TABLE tags (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  description TEXT,
  metadata TEXT, -- JSON
  created_by TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- タグ間の関連（親子関係）
CREATE TABLE tag_associations (
  tag_id TEXT NOT NULL,              -- 親タグ
  associated_tag_id TEXT NOT NULL,   -- 子タグ
  association_order INTEGER DEFAULT 0, -- 表示順
  created_at TEXT NOT NULL,
  PRIMARY KEY (tag_id, associated_tag_id),
  FOREIGN KEY (tag_id) REFERENCES tags(id),
  FOREIGN KEY (associated_tag_id) REFERENCES tags(id)
);

-- ログとタグの紐付け
CREATE TABLE log_tag_associations (
  log_id TEXT NOT NULL,
  tag_id TEXT NOT NULL,
  association_order INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  PRIMARY KEY (log_id, tag_id)
);
```

### 5. UXフロー詳細

#### シナリオ1: 新規ログ作成（関連タグ活用）

```
1. ユーザー: ログ作成ボタンをクリック
   ↓
2. システム: LogFormを表示、内容欄にフォーカス
   ↓
3. ユーザー: "#進" と入力
   ↓
4. システム: 
   - API呼び出し: GET /api/tags/suggestions?q=進&limit=5
   - 候補を表示: ["進撃の巨人", "進研ゼミ", ...]
   ↓
5. ユーザー: "進撃の巨人" を選択（クリックまたはEnter）
   ↓
6. システム:
   - テキストを "#進撃の巨人 " に置換
   - API呼び出し: GET /api/tags/進撃の巨人/associations
   - 関連タグを候補として表示: ["第1話", "第2話", "第3話", ...]
   - 候補見出しに「関連タグ」と表示
   ↓
7. ユーザー: "第5話" を選択
   ↓
8. システム:
   - テキストを "#進撃の巨人 #{第5話} " に変更
   - 候補を閉じる
   ↓
9. ユーザー: 追加の内容を入力してログを保存
```

#### シナリオ2: 継続記録（最近使用タグ）

```
1. ユーザー: ログ作成ボタンをクリック
   ↓
2. システム: LogFormを表示、内容欄にフォーカス
   ↓
3. ユーザー: "#" と入力
   ↓
4. システム:
   - API呼び出し: GET /api/users/me/recent-tags?limit=10
   - 最近使用したタグを表示
   - 候補見出しに「最近使用したタグ」と表示
   ↓
5. ユーザー: タグを選択
   ↓
6. システム: テキストを置換、必要に応じて関連タグを表示
```

#### シナリオ3: タグ詳細ページからのログ作成

```
1. ユーザー: タグ詳細ページを閲覧（例: 「進撃の巨人」）
   - ページには関連タグが表示されている: ["第1話", "第2話", "第3話", ...]
   ↓
2. ユーザー: ページ上部の「このタグでログを作成」ボタンをクリック
   ↓
3. システム:
   - LogFormダイアログを表示
   - 内容欄に "#進撃の巨人 " を自動挿入
   - カーソルをタグの後ろに配置
   - 関連タグを候補として即座に表示
   - 候補見出しに「進撃の巨人 の関連タグ」と表示
   ↓
4. ユーザー: 候補から "第5話" を選択
   ↓
5. システム:
   - テキストを "#進撃の巨人 #{第5話} " に更新
   - 候補を閉じる
   ↓
6. ユーザー: 感想や詳細を追加入力してログを保存
```

#### シナリオ4: タグ詳細ページの関連タグから直接作成

```
1. ユーザー: タグ詳細ページを閲覧（例: 「進撃の巨人」）
   - 関連タグ一覧を確認: ["第1話", "第2話", "第3話", ...]
   ↓
2. ユーザー: 関連タグ「第5話」にマウスホバー
   ↓
3. システム: 「ログを作成」アイコンを表示
   ↓
4. ユーザー: アイコンをクリック
   ↓
5. システム:
   - LogFormダイアログを表示
   - 内容欄に "#進撃の巨人 #{第5話} " を自動挿入（親タグ + 子タグ）
   - カーソルをタグの後ろに配置
   - 他の関連タグも候補として表示（追加選択可能）
   ↓
6. ユーザー: 
   - 必要に応じて追加のタグを選択
   - 感想や詳細を入力してログを保存

**利点**:
- 1クリックでエピソード指定が完了
- 親子関係のタグが両方自動挿入される
- 入力の手間が最小化
```

### 6. キーボードショートカット

ユーザビリティ向上のため、以下のキーボード操作をサポート：

- `↑` / `↓`: 候補リスト内を移動
- `Enter`: 選択中のタグを挿入
- `Esc`: 候補リストを閉じる
- `Tab`: 選択中のタグを挿入（Enterと同じ）

### 7. パフォーマンス考慮事項

#### 7.1 デバウンス
- ユーザーの入力が止まってから300msでAPI呼び出し
- 連続入力時のAPI呼び出し回数を削減

#### 7.2 キャッシュ
- 検索結果をローカルにキャッシュ（5分間有効）
- 最近使用タグは初回ロード時に取得してキャッシュ

#### 7.3 プリフェッチ
- ログ作成画面表示時に最近使用タグを先行ロード
- バックグラウンドで人気タグTop 20を取得

### 8. アクセシビリティ

- `aria-autocomplete="list"`: オートコンプリートであることを明示
- `aria-expanded`: 候補リストの表示状態
- `aria-activedescendant`: 選択中の候補項目
- スクリーンリーダー対応: 候補数と選択中の項目を読み上げ

### 9. 段階的実装計画

#### Phase 1: 基本的なオートコンプリート（MVP）
- [ ] TagAutocompleteコンポーネントの実装
- [ ] タグ候補API (`GET /api/tags/suggestions`) の実装
- [ ] 基本的な候補表示とテキスト挿入

#### Phase 2: 関連タグサポート
- [ ] タグ選択時の関連タグ自動表示
- [ ] 関連タグAPIの統合（既存エンドポイント活用）
- [ ] 候補タイプの視覚的区別

#### Phase 2.5: タグ詳細ページからのログ作成
- [ ] TagDetailPageの「このタグでログを作成」機能の拡張
  - [ ] 親タグの自動挿入
  - [ ] 関連タグの即座表示
- [ ] 関連タグから直接ログを作成する機能
  - [ ] ホバー時の「ログを作成」アイコン表示
  - [ ] 親タグ + 子タグの自動挿入
- [ ] LogFormの初期値設定機能の拡張

#### Phase 3: パーソナライゼーション
- [ ] 最近使用タグAPI (`GET /api/users/me/recent-tags`) の実装
- [ ] 最近使用タグの優先表示
- [ ] ユーザー行動に基づく候補ソート

#### Phase 4: UX最適化
- [ ] デバウンスとキャッシュの実装
- [ ] キーボードショートカットの完全サポート
- [ ] アクセシビリティの強化
- [ ] モバイル対応の最適化

### 10. 成功指標

実装の効果を測定する指標：

1. **タスク完了時間**: エピソード記録タスクの平均完了時間（現状比50%削減目標）
   - ログ作成画面からの記録: 目標 30秒以内
   - タグ詳細ページからの記録: 目標 20秒以内（親タグ自動挿入により更に短縮）
2. **タグの一貫性**: 同一作品/商品に対する異なるタグ表記の削減（現状比70%削減目標）
3. **ユーザー満足度**: タグ入力の使いやすさに関するフィードバック
4. **採用率**: 
   - オートコンプリート機能の使用率（目標: 80%以上）
   - タグ詳細ページからのログ作成率（目標: 40%以上）
5. **タグ詳細ページのエンゲージメント**: 
   - 関連タグクリック率の向上
   - タグ詳細ページからのログ作成フロー完了率

### 11. リスクと制約

#### リスク
1. **パフォーマンス**: 大量のタグ候補表示時の描画速度
   - 対策: 仮想スクロール、段階的ロード

2. **モバイルUX**: 小画面での候補リスト表示
   - 対策: モーダル表示、タップ最適化

3. **学習コスト**: 新しいUI要素への適応
   - 対策: オンボーディング、ツールチップ

#### 制約
1. **既存データ**: 既存のタグ構造を維持
2. **API互換性**: 既存のエンドポイントを破壊しない
3. **バックエンドリソース**: Cloudflare Workers の実行時間制限

### 12. 今後の拡張可能性

- **AI支援**: 内容から自動的にタグを提案
- **タグテンプレート**: よく使うタグセットを保存・再利用
- **タググループ**: 複数タグをグループ化して一括選択
- **タグ階層の可視化**: ツリー表示でタグ構造を確認

## まとめ

この設計は、既存のshumilogアーキテクチャを最大限活用しつつ、ユーザーの「作品のエピソード記録」「商品ブランドの製品記録」といったユースケースを直感的に実現します。

**主な利点**:
- 最小限の変更で最大の効果
- 既存のタグ関連機能（tag_associations）の有効活用
- 段階的な実装が可能
- 将来の拡張に柔軟に対応

**タグ詳細ページからのログ作成の利点**:
- タグ閲覧からログ作成への自然な導線
- 親タグが自動挿入されるため入力の手間が大幅削減
- 関連タグが即座に候補表示され、エピソード選択が容易
- ホバー操作で関連タグから直接ログ作成（1クリック完結）
- タグの階層構造を意識したUXにより、タグの使い方を学習しやすい

**実現する主要なユーザー体験**:
1. **ログ作成画面**: ハッシュタグ入力でリアルタイム候補表示 → 3クリックで完了
2. **タグ詳細ページ**: 「このタグでログを作成」から親タグ自動挿入 → 2クリックで完了
3. **関連タグから直接**: ホバー + クリックで親子タグ両方挿入 → 1クリックで完了

**次のステップ**:
設計レビューとフィードバックを受けて、Phase 1の実装に着手します。
