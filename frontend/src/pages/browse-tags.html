<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Tags - Shumilog</title>
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <nav class="navigation">
                <a href="/" class="nav-link">‚Üê Home</a>
                <h1>Browse Tags</h1>
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
            </nav>
        </header>

        <main class="browse-content">
            <section class="search-section">
                <div class="search-bar">
                    <input 
                        type="text" 
                        id="tagSearchInput" 
                        placeholder="Search tags..."
                        autocomplete="off"
                    >
                    <button type="button" id="searchButton" class="btn btn-primary">Search</button>
                </div>
                <div class="search-filters">
                    <label class="filter-option">
                        <input type="checkbox" id="showEpisodic"> 
                        Show episodic content
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" id="showWithLogs" checked> 
                        Only tags with logs
                    </label>
                </div>
            </section>

            <section class="tags-section">
                <div id="loadingIndicator" class="loading">Loading tags...</div>
                <div id="tagsContainer" class="tags-grid hidden"></div>
                <div id="paginationContainer" class="pagination hidden"></div>
            </section>

            <section class="popular-section">
                <h2>Popular Tags</h2>
                <div id="popularTags" class="popular-tags-list"></div>
            </section>

            <section class="recent-section">
                <h2>Recent Activity</h2>
                <div id="recentLogs" class="recent-logs-list"></div>
            </section>
        </main>
    </div>

    <script>
        // State management
        let currentPage = 0;
        let currentSearch = '';
        let totalPages = 0;

        // Load tags with search and pagination
        async function loadTags(page = 0, search = '') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tagsContainer = document.getElementById('tagsContainer');
            
            loadingIndicator.classList.remove('hidden');
            tagsContainer.classList.add('hidden');

            try {
                const params = new URLSearchParams({
                    limit: '20',
                    offset: String(page * 20)
                });
                
                if (search) {
                    params.append('search', search);
                }

                const response = await fetch(`/tags?${params}`);
                const data = await response.json();
                
                displayTags(data.items || []);
                updatePagination(data.total || 0, data.limit || 20, data.offset || 0);
                
                currentPage = page;
                currentSearch = search;
                
            } catch (error) {
                console.error('Failed to load tags:', error);
                tagsContainer.innerHTML = '<div class="error">Failed to load tags. Please try again.</div>';
            } finally {
                loadingIndicator.classList.add('hidden');
                tagsContainer.classList.remove('hidden');
            }
        }

        // Display tags in grid
        function displayTags(tags) {
            const container = document.getElementById('tagsContainer');
            
            if (tags.length === 0) {
                container.innerHTML = '<div class="no-results">No tags found matching your search.</div>';
                return;
            }

            container.innerHTML = tags.map(tag => `
                <div class="tag-card" data-id="${tag.id}">
                    <h3 class="tag-name">${tag.name}</h3>
                    ${tag.description ? `<p class="tag-description">${tag.description}</p>` : ''}
                    <div class="tag-metadata">
                        ${tag.metadata && tag.metadata.year ? `<span class="tag-year">${tag.metadata.year}</span>` : ''}
                        ${tag.metadata && tag.metadata.studio ? `<span class="tag-studio">${tag.metadata.studio}</span>` : ''}
                        ${tag.metadata && tag.metadata.supports_episodes ? '<span class="tag-episodic">üì∫ Episodic</span>' : ''}
                    </div>
                    <div class="tag-actions">
                        <button class="btn btn-sm" onclick="viewTagDetails('${tag.id}')">View Details</button>
                        <button class="btn btn-sm btn-secondary" onclick="viewTagLogs('${tag.id}')">View Logs</button>
                    </div>
                </div>
            `).join('');
        }

        // Update pagination controls
        function updatePagination(total, limit, offset) {
            const container = document.getElementById('paginationContainer');
            totalPages = Math.ceil(total / limit);
            const currentPageNum = Math.floor(offset / limit);

            if (totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            let paginationHTML = '<div class="pagination-controls">';
            
            // Previous button
            if (currentPageNum > 0) {
                paginationHTML += `<button class="btn btn-sm" onclick="changePage(${currentPageNum - 1})">‚Üê Previous</button>`;
            }
            
            // Page numbers
            for (let i = Math.max(0, currentPageNum - 2); i <= Math.min(totalPages - 1, currentPageNum + 2); i++) {
                const isActive = i === currentPageNum;
                paginationHTML += `<button class="btn btn-sm ${isActive ? 'btn-primary' : ''}" onclick="changePage(${i})">${i + 1}</button>`;
            }
            
            // Next button
            if (currentPageNum < totalPages - 1) {
                paginationHTML += `<button class="btn btn-sm" onclick="changePage(${currentPageNum + 1})">Next ‚Üí</button>`;
            }
            
            paginationHTML += '</div>';
            paginationHTML += `<div class="pagination-info">Showing ${offset + 1}-${Math.min(offset + limit, total)} of ${total} tags</div>`;
            
            container.innerHTML = paginationHTML;
            container.classList.remove('hidden');
        }

        // Load popular tags
        async function loadPopularTags() {
            try {
                const response = await fetch('/tags?limit=10&sort=popular');
                const data = await response.json();
                
                const container = document.getElementById('popularTags');
                container.innerHTML = (data.items || []).map(tag => `
                    <div class="popular-tag" onclick="viewTagDetails('${tag.id}')">
                        <span class="tag-name">${tag.name}</span>
                        <span class="tag-count">${tag.log_count || 0} logs</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load popular tags:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const response = await fetch('/logs?limit=5&public=true');
                const data = await response.json();
                
                const container = document.getElementById('recentLogs');
                container.innerHTML = (data.items || []).map(log => `
                    <div class="recent-log" onclick="viewLog('${log.id}')">
                        <h4 class="log-title">${log.title}</h4>
                        <div class="log-tags">
                            ${(log.tags || []).map(tag => `<span class="tag-badge">${tag.name}</span>`).join('')}
                        </div>
                        <div class="log-meta">
                            by ${log.user_display_name || 'Anonymous'} ‚Ä¢ ${formatDate(log.created_at)}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent activity:', error);
            }
        }

        // Event handlers
        function changePage(page) {
            loadTags(page, currentSearch);
        }

        function viewTagDetails(tagId) {
            window.location.href = `/tags/${tagId}`;
        }

        function viewTagLogs(tagId) {
            window.location.href = `/logs?tag_ids=${tagId}`;
        }

        function viewLog(logId) {
            window.location.href = `/logs/${logId}`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('tagSearchInput');
            const searchButton = document.getElementById('searchButton');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadTags(0, e.target.value);
                }, 300);
            });
            
            searchButton.addEventListener('click', () => {
                loadTags(0, searchInput.value);
            });
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    loadTags(0, searchInput.value);
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            setupSearch();
            loadTags();
            loadPopularTags();
            loadRecentActivity();
        });
    </script>
</body>
</html>