<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Log - Shumilog</title>
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <nav class="navigation">
                <a href="/" class="nav-link">← Back</a>
                <h1>Create Log</h1>
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
            </nav>
        </header>

        <main class="create-log-content">
            <form id="createLogForm" class="log-form">
                <div class="form-group">
                    <label for="title">Log Title</label>
                    <input 
                        type="text" 
                        id="title" 
                        name="title" 
                        placeholder="e.g., Amazing first season!"
                        required
                        maxlength="200"
                    >
                </div>

                <div class="form-group">
                    <label for="content">Content (Markdown supported)</label>
                    <textarea 
                        id="content" 
                        name="content" 
                        placeholder="Write your thoughts here... You can use **bold**, *italic*, and other Markdown formatting."
                        required
                        rows="8"
                        maxlength="10000"
                    ></textarea>
                    <small class="form-help">Supports GitHub Flavored Markdown</small>
                </div>

                <div class="form-group">
                    <label for="tags">Tags</label>
                    <div class="tag-input-container">
                        <input 
                            type="text" 
                            id="tagSearch" 
                            placeholder="Search or create tags..."
                            autocomplete="off"
                        >
                        <div id="tagSuggestions" class="tag-suggestions hidden"></div>
                    </div>
                    <div id="selectedTags" class="selected-tags"></div>
                    <small class="form-help">Type to search existing tags or create new ones</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isPublic" name="isPublic">
                        <span class="checkmark"></span>
                        Make this log public
                    </label>
                    <small class="form-help">Public logs can be discovered by other users through tags</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="saveDraft">Save Draft</button>
                    <button type="submit" class="btn btn-primary">Create Log</button>
                </div>
            </form>
        </main>
    </div>

    <script>
        // Tag management functionality
        let selectedTags = [];
        let availableTags = [];
        
        // Fetch available tags
        async function loadTags() {
            try {
                const response = await fetch('/tags');
                const data = await response.json();
                availableTags = data.items || [];
            } catch (error) {
                console.error('Failed to load tags:', error);
                availableTags = [];
            }
        }

        // Tag search and suggestions
        function setupTagInput() {
            const tagSearch = document.getElementById('tagSearch');
            const tagSuggestions = document.getElementById('tagSuggestions');
            const selectedTagsContainer = document.getElementById('selectedTags');

            tagSearch.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 1) {
                    tagSuggestions.classList.add('hidden');
                    return;
                }

                const filtered = availableTags.filter(tag => 
                    tag.name.toLowerCase().includes(query) &&
                    !selectedTags.some(selected => selected.id === tag.id)
                );

                if (filtered.length > 0 || query.length > 0) {
                    showSuggestions(filtered, query);
                } else {
                    tagSuggestions.classList.add('hidden');
                }
            });

            tagSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    createNewTag(e.target.value.trim());
                }
            });
        }

        function showSuggestions(filtered, query) {
            const tagSuggestions = document.getElementById('tagSuggestions');
            let html = '';

            filtered.forEach(tag => {
                html += `<div class="tag-suggestion" data-id="${tag.id}" data-name="${tag.name}">
                    <strong>${tag.name}</strong>
                    ${tag.description ? `<small>${tag.description}</small>` : ''}
                </div>`;
            });

            if (query && !filtered.some(tag => tag.name.toLowerCase() === query.toLowerCase())) {
                html += `<div class="tag-suggestion create-new" data-name="${query}">
                    <strong>+ Create "${query}"</strong>
                </div>`;
            }

            tagSuggestions.innerHTML = html;
            tagSuggestions.classList.remove('hidden');

            // Add click handlers
            tagSuggestions.querySelectorAll('.tag-suggestion').forEach(elem => {
                elem.addEventListener('click', () => {
                    if (elem.classList.contains('create-new')) {
                        createNewTag(elem.dataset.name);
                    } else {
                        addTag({
                            id: elem.dataset.id,
                            name: elem.dataset.name
                        });
                    }
                });
            });
        }

        function addTag(tag) {
            if (!selectedTags.some(selected => selected.id === tag.id)) {
                selectedTags.push(tag);
                renderSelectedTags();
                document.getElementById('tagSearch').value = '';
                document.getElementById('tagSuggestions').classList.add('hidden');
            }
        }

        function createNewTag(name) {
            // For now, create a temporary tag - this will be handled by the backend
            const tempTag = {
                id: 'temp_' + Date.now(),
                name: name,
                isNew: true
            };
            addTag(tempTag);
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = selectedTags.map(tag => `
                <div class="selected-tag" data-id="${tag.id}">
                    ${tag.name}
                    ${tag.isNew ? '<span class="new-tag-indicator">new</span>' : ''}
                    <button type="button" class="remove-tag" onclick="removeTag('${tag.id}')">×</button>
                </div>
            `).join('');
        }

        function removeTag(tagId) {
            selectedTags = selectedTags.filter(tag => tag.id !== tagId);
            renderSelectedTags();
        }

        // Form submission
        document.getElementById('createLogForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                content_md: document.getElementById('content').value,
                is_public: document.getElementById('isPublic').checked,
                tags: selectedTags
            };

            try {
                const response = await fetch('/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData),
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Log created successfully!');
                    window.location.href = `/logs/${result.id}`;
                } else {
                    const error = await response.json();
                    alert('Error creating log: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to create log:', error);
                alert('Failed to create log. Please try again.');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTags();
            setupTagInput();
        });
    </script>
</body>
</html>