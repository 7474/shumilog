<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Shumilog</title>
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <nav class="navigation">
                <a href="/" class="nav-link">Home</a>
                <h1>Dashboard</h1>
                <div class="nav-actions">
                    <a href="/create-log.html" class="btn btn-primary">+ New Log</a>
                    <button id="logoutButton" class="btn btn-secondary">Logout</button>
                </div>
            </nav>
        </header>

        <main class="dashboard-content">
            <!-- User Profile Section -->
            <section class="profile-section">
                <div id="userProfile" class="user-profile">
                    <div class="profile-loading">Loading profile...</div>
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="stats-section">
                <h2>Your Activity</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLogs">-</div>
                        <div class="stat-label">Total Logs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="publicLogs">-</div>
                        <div class="stat-label">Public Logs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="uniqueTags">-</div>
                        <div class="stat-label">Tags Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisWeekLogs">-</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>
            </section>

            <!-- Recent Logs -->
            <section class="recent-logs-section">
                <div class="section-header">
                    <h2>Recent Logs</h2>
                    <div class="section-actions">
                        <select id="logsFilter">
                            <option value="all">All Logs</option>
                            <option value="public">Public Only</option>
                            <option value="private">Private Only</option>
                            <option value="drafts">Drafts</option>
                        </select>
                        <a href="/browse-tags.html" class="btn btn-secondary">Browse Tags</a>
                    </div>
                </div>
                <div id="recentLogs" class="logs-list">
                    <div class="loading">Loading your logs...</div>
                </div>
                <div id="logsPagination" class="pagination hidden"></div>
            </section>

            <!-- Tag Activity -->
            <section class="tag-activity-section">
                <h2>Your Most Used Tags</h2>
                <div id="topTags" class="top-tags-list">
                    <div class="loading">Loading tag statistics...</div>
                </div>
            </section>

            <!-- Progress Tracking -->
            <section class="progress-section">
                <h2>Content Progress</h2>
                <div id="progressTracker" class="progress-tracker">
                    <div class="loading">Loading progress...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentLogsPage = 0;
        let currentLogsFilter = 'all';

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch('/users/me', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    displayUserProfile(currentUser);
                } else if (response.status === 401) {
                    // Not authenticated, redirect to home
                    window.location.href = '/';
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('userProfile').innerHTML = '<div class="error">Failed to load profile</div>';
            }
        }

        // Display user profile
        function displayUserProfile(user) {
            const container = document.getElementById('userProfile');
            container.innerHTML = `
                <div class="profile-info">
                    ${user.avatar_url ? `<img src="${user.avatar_url}" alt="Profile" class="profile-avatar">` : ''}
                    <div class="profile-details">
                        <h3>${user.display_name}</h3>
                        <p class="profile-username">@${user.twitter_username}</p>
                        <p class="profile-joined">Joined ${formatDate(user.created_at)}</p>
                    </div>
                </div>
            `;
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                const response = await fetch('/users/me/stats', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    displayUserStats(stats);
                } else {
                    console.error('Failed to load stats');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Display user statistics
        function displayUserStats(stats) {
            document.getElementById('totalLogs').textContent = stats.total_logs || 0;
            document.getElementById('publicLogs').textContent = stats.public_logs || 0;
            document.getElementById('uniqueTags').textContent = stats.unique_tags || 0;
            document.getElementById('thisWeekLogs').textContent = stats.this_week_logs || 0;
        }

        // Load user's recent logs
        async function loadUserLogs(page = 0, filter = 'all') {
            const container = document.getElementById('recentLogs');
            container.innerHTML = '<div class="loading">Loading logs...</div>';

            try {
                const params = new URLSearchParams({
                    limit: '10',
                    offset: String(page * 10),
                    user_id: currentUser.id
                });

                if (filter !== 'all') {
                    if (filter === 'public') params.append('public', 'true');
                    if (filter === 'private') params.append('public', 'false');
                    if (filter === 'drafts') params.append('status', 'draft');
                }

                const response = await fetch(`/logs?${params}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayUserLogs(data.items || []);
                    updateLogsPagination(data.total || 0, data.limit || 10, data.offset || 0);
                } else {
                    throw new Error('Failed to load logs');
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                container.innerHTML = '<div class="error">Failed to load logs</div>';
            }
        }

        // Display user logs
        function displayUserLogs(logs) {
            const container = document.getElementById('recentLogs');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="no-logs">
                        <p>No logs found.</p>
                        <a href="/create-log.html" class="btn btn-primary">Create your first log</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-card" data-id="${log.id}">
                    <div class="log-header">
                        <h3 class="log-title">${log.title}</h3>
                        <div class="log-status">
                            ${log.is_public ? '<span class="status-badge public">Public</span>' : '<span class="status-badge private">Private</span>'}
                            ${log.status === 'draft' ? '<span class="status-badge draft">Draft</span>' : ''}
                        </div>
                    </div>
                    <div class="log-content-preview">
                        ${log.content_md ? log.content_md.substring(0, 150) + (log.content_md.length > 150 ? '...' : '') : ''}
                    </div>
                    <div class="log-tags">
                        ${(log.tags || []).map(tag => `<span class="tag-badge">${tag.name}</span>`).join('')}
                    </div>
                    <div class="log-footer">
                        <div class="log-date">${formatDate(log.created_at)}</div>
                        <div class="log-actions">
                            <button class="btn btn-sm" onclick="viewLog('${log.id}')">View</button>
                            <button class="btn btn-sm btn-secondary" onclick="editLog('${log.id}')">Edit</button>
                            ${log.is_public ? `<button class="btn btn-sm" onclick="shareLog('${log.id}')">Share</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update logs pagination
        function updateLogsPagination(total, limit, offset) {
            const container = document.getElementById('logsPagination');
            const totalPages = Math.ceil(total / limit);
            const currentPageNum = Math.floor(offset / limit);

            if (totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            let html = '<div class="pagination-controls">';
            
            if (currentPageNum > 0) {
                html += `<button class="btn btn-sm" onclick="changeLogsPage(${currentPageNum - 1})">← Previous</button>`;
            }
            
            for (let i = Math.max(0, currentPageNum - 2); i <= Math.min(totalPages - 1, currentPageNum + 2); i++) {
                const isActive = i === currentPageNum;
                html += `<button class="btn btn-sm ${isActive ? 'btn-primary' : ''}" onclick="changeLogsPage(${i})">${i + 1}</button>`;
            }
            
            if (currentPageNum < totalPages - 1) {
                html += `<button class="btn btn-sm" onclick="changeLogsPage(${currentPageNum + 1})">Next →</button>`;
            }
            
            html += '</div>';
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        // Load top tags
        async function loadTopTags() {
            try {
                const response = await fetch(`/users/me/tags?limit=10`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const tags = await response.json();
                    displayTopTags(tags);
                } else {
                    document.getElementById('topTags').innerHTML = '<div class="no-data">No tag data available</div>';
                }
            } catch (error) {
                console.error('Error loading top tags:', error);
                document.getElementById('topTags').innerHTML = '<div class="error">Failed to load tag statistics</div>';
            }
        }

        // Display top tags
        function displayTopTags(tags) {
            const container = document.getElementById('topTags');
            
            if (!tags || tags.length === 0) {
                container.innerHTML = '<div class="no-data">No tags used yet</div>';
                return;
            }

            container.innerHTML = tags.map(tag => `
                <div class="top-tag-item" onclick="viewTagLogs('${tag.id}')">
                    <div class="tag-info">
                        <span class="tag-name">${tag.name}</span>
                        <span class="tag-count">${tag.usage_count || 0} logs</span>
                    </div>
                    <div class="tag-progress">
                        <div class="progress-bar" style="width: ${Math.min(100, (tag.usage_count || 0) * 10)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // Event handlers
        function changeLogsPage(page) {
            currentLogsPage = page;
            loadUserLogs(page, currentLogsFilter);
        }

        function viewLog(logId) {
            window.location.href = `/logs/${logId}`;
        }

        function editLog(logId) {
            window.location.href = `/logs/${logId}/edit`;
        }

        function shareLog(logId) {
            const shareUrl = `${window.location.origin}/logs/${logId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Check out my log on Shumilog',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                alert('Share URL copied to clipboard!');
            }
        }

        function viewTagLogs(tagId) {
            window.location.href = `/logs?tag_ids=${tagId}`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logs filter
            document.getElementById('logsFilter').addEventListener('change', (e) => {
                currentLogsFilter = e.target.value;
                currentLogsPage = 0;
                loadUserLogs(0, currentLogsFilter);
            });

            // Logout button
            document.getElementById('logoutButton').addEventListener('click', async () => {
                try {
                    await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout failed:', error);
                    window.location.href = '/';
                }
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            await loadUserProfile();
            
            if (currentUser) {
                loadUserStats();
                loadUserLogs();
                loadTopTags();
            }
        });
    </script>
</body>
</html>