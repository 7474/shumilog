# コンテンツアクセスリンク機能 - アーキテクチャ図

## システム構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー（ブラウザ）                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    フロントエンド (React)                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                     │
│  │ TagDetailPage    │  │ LogDetailPage    │                     │
│  │                  │  │                  │                     │
│  │ - タグ情報表示    │  │ - ログ本文表示    │                     │
│  │ - 関連リンク表示  │  │ - タグ一覧表示    │                     │
│  │                  │  │ - 関連リンク表示  │                     │
│  └────────┬─────────┘  └────────┬─────────┘                     │
│           │                     │                               │
│           └──────────┬──────────┘                               │
│                      ▼                                           │
│         ┌────────────────────────┐                              │
│         │   ContentLinks.tsx     │                              │
│         │   (新規コンポーネント)   │                              │
│         │                        │                              │
│         │ - リンク一覧表示        │                              │
│         │ - アイコンマッピング    │                              │
│         │ - URLバリデーション     │                              │
│         └────────────────────────┘                              │
└────────────────────────┬────────────────────────────────────────┘
                         │ API Request
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              バックエンド (Cloudflare Workers + Hono)             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                     │
│  │ GET /tags/{id}   │  │ POST /tags       │                     │
│  │                  │  │ PUT /tags/{id}   │                     │
│  │ タグ詳細取得      │  │                  │                     │
│  │ (metadata含む)   │  │ タグ作成・更新    │                     │
│  └────────┬─────────┘  └────────┬─────────┘                     │
│           │                     │                               │
│           └──────────┬──────────┘                               │
│                      ▼                                           │
│         ┌────────────────────────┐                              │
│         │      TagModel          │                              │
│         │                        │                              │
│         │ - parseMetadata()      │                              │
│         │ - serializeMetadata()  │                              │
│         │ - isValidMetadata() ⭐ │  ← 新規追加                   │
│         │ - isValidUrl() ⭐       │  ← 新規追加                   │
│         └────────────────────────┘                              │
└────────────────────────┬────────────────────────────────────────┘
                         │ SQL Query
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    データベース (Cloudflare D1)                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ tags テーブル                                               │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │ id          TEXT PRIMARY KEY                               │ │
│  │ name        TEXT UNIQUE NOT NULL                           │ │
│  │ description TEXT                                           │ │
│  │ metadata    TEXT NOT NULL DEFAULT '{}'  ⭐                 │ │
│  │             ↑ JSON文字列でリンク情報を格納                  │ │
│  │ created_by  TEXT NOT NULL                                  │ │
│  │ created_at  TEXT NOT NULL                                  │ │
│  │ updated_at  TEXT NOT NULL                                  │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## データフロー

### タグ詳細ページの表示

```
1. ユーザーがタグをクリック
   │
   ▼
2. TagDetailPage が GET /tags/{id} をリクエスト
   │
   ▼
3. バックエンドが D1 からタグ情報を取得
   │
   ▼
4. TagModel.parseMetadata() でメタデータをパース
   │
   ▼
5. API レスポンス (metadata.links を含む)
   │
   ▼
6. TagDetailPage が ContentLinks コンポーネントに links を渡す
   │
   ▼
7. ContentLinks がリンクをレンダリング
   │
   ▼
8. ユーザーがリンクをクリック → 新しいタブで外部サイトが開く
```

### タグ作成・更新

```
1. ユーザーがタグフォームを送信（metadata.links を含む）
   │
   ▼
2. POST /tags または PUT /tags/{id} をリクエスト
   │
   ▼
3. バックエンドで TagModel.isValidMetadata() を実行
   │
   ├─ Valid → 続行
   │
   └─ Invalid → 400 Bad Request エラー
   │
   ▼
4. TagModel.serializeMetadata() で JSON 文字列に変換
   │
   ▼
5. D1 に保存
   │
   ▼
6. 成功レスポンス
```

## メタデータ構造

```json
// tags.metadata カラムの内容（TEXT型、JSON文字列）
{
  "category": "anime",
  "year": 2013,
  "studio": "Studio WIT",
  "episodes": 25,
  "links": {                    ← 新規追加
    "official": "https://shingeki.tv/",
    "wikipedia": "https://ja.wikipedia.org/wiki/進撃の巨人",
    "myanimelist": "https://myanimelist.net/anime/16498/",
    "crunchyroll": "https://www.crunchyroll.com/series/GR751KNZY/",
    "netflix": "https://www.netflix.com/title/70299043",
    "amazon": "https://www.amazon.co.jp/dp/B00F3S9TXE",
    "custom": [
      {
        "name": "進撃の巨人 Wiki",
        "url": "https://attackontitan.fandom.com/wiki/",
        "icon": "📚"
      }
    ]
  }
}
```

## UIコンポーネント構造

```
TagDetailPage
├─ Card (shadcn/ui)
│  ├─ CardHeader
│  │  └─ CardTitle (タグ名)
│  │
│  └─ CardContent
│     ├─ 説明セクション (description)
│     │
│     ├─ 関連リンクセクション ⭐ 新規追加
│     │  └─ ContentLinks
│     │     └─ Button (リンクごと)
│     │        ├─ Emoji アイコン
│     │        ├─ ラベル
│     │        └─ ExternalLink アイコン
│     │
│     ├─ 情報セクション (使用回数、作成日等)
│     │
│     └─ 関連タグセクション
│
└─ recent_logs (新着ログ一覧)
```

## セキュリティフロー

```
ユーザー入力 URL
   │
   ▼
TagModel.isValidUrl()
   │
   ├─ スキームチェック
   │  ├─ http:  ✅ OK
   │  ├─ https: ✅ OK
   │  ├─ javascript: ❌ 拒否
   │  ├─ data: ❌ 拒否
   │  └─ vbscript: ❌ 拒否
   │
   ├─ URL形式チェック
   │  ├─ 有効 ✅ OK
   │  └─ 無効 ❌ 拒否
   │
   ├─ 長さチェック
   │  ├─ ≤2048文字 ✅ OK
   │  └─ >2048文字 ❌ 拒否
   │
   ▼
有効なURLのみDBに保存
   │
   ▼
フロントエンドで表示
   │
   └─ <a target="_blank" rel="noopener noreferrer">
      ↑ XSS対策、タブナビング対策
```

## 実装の影響範囲

```
変更が必要なファイル:
├─ backend/
│  ├─ src/models/Tag.ts ⭐
│  │  └─ isValidMetadata(), isValidUrl() 追加
│  └─ src/db/seeds.sql ⭐
│     └─ リンク情報を含むシードデータ追加
│
├─ frontend/
│  ├─ src/components/ContentLinks.tsx ⭐ 新規作成
│  │  └─ リンク表示コンポーネント
│  ├─ src/pages/TagDetailPage.tsx ⭐
│  │  └─ ContentLinks 統合
│  └─ src/pages/LogDetailPage.tsx ⭐
│     └─ ContentLinks 統合（タグから集約）
│
└─ specs/
   └─ 005-content-links/ ⭐ 新規作成
      ├─ README.md
      ├─ spec.md
      ├─ design.md
      ├─ data-model.md
      ├─ research.md
      └─ quickstart.md

変更不要なファイル:
├─ api/v1/openapi.yaml (既存のTag定義を使用)
├─ backend/src/routes/ (既存のエンドポイントを使用)
└─ backend/migrations/ (スキーマ変更なし)
```

## Phase 2の拡張（将来）

```
┌─────────────────────────────────────────────────────────────────┐
│                         将来の拡張                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 1. ログのメタデータ対応                                      │ │
│  │    - logs テーブルに metadata カラムを追加                  │ │
│  │    - ログ固有のリンクをサポート                              │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 2. リンクプレビュー                                          │ │
│  │    - Open Graph API で情報取得                              │ │
│  │    - サムネイル画像とタイトルを表示                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 3. 自動リンク生成                                            │ │
│  │    - タグ名から Wikipedia URL を自動生成                    │ │
│  │    - Wikidata API 統合                                      │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 4. リンク分析                                                │ │
│  │    - クリック数を記録                                        │ │
│  │    - 人気のリンクをハイライト                                │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

**凡例**:
- ⭐ = 新規追加または変更が必要
- ✅ = 許可
- ❌ = 拒否
