# コンテンツアクセスリンク機能 - 仕様書

## 概要

ログやタグに関連する外部コンテンツ（公式サイト、Wikipedia、購入URL、ストリーミングサービス等）へのリンクを提供する機能。

## 目的

1. **ユーザー体験の向上**: 趣味コンテンツに関する情報収集を容易にする
2. **コンテンツへのアクセス**: 公式ページや購入ページへの直接的な導線を提供
3. **情報の充実**: メタデータの活用により、コンテンツの詳細情報を提供
4. **拡張性の確保**: 将来的な機能拡張に対応できる柔軟な設計

## ユーザーストーリー

### ストーリー1: アニメ作品の情報を探す

**背景**: ユーザーAliceは、あるログで紹介されているアニメ作品について、もっと詳しく知りたい。

**アクション**:
1. ログ詳細ページを開く
2. タグ「Attack on Titan」をクリック
3. タグ詳細ページで「🔗 関連リンク」セクションを確認
4. 「📖 Wikipedia」をクリックして作品情報を確認
5. 「📺 Netflix」をクリックして視聴する

**結果**: Aliceは簡単に作品情報を得て、すぐに視聴を開始できた。

### ストーリー2: ゲームを購入する

**背景**: ユーザーBobは、友人がログで紹介しているゲームを購入したい。

**アクション**:
1. ログ詳細ページを開く
2. 「🔗 関連リンク」セクションを確認
3. 「🎮 Steam」または「🛒 Amazon」のリンクをクリック
4. 購入ページで直接購入

**結果**: Bobは複数の購入オプションから選択でき、スムーズに購入できた。

### ストーリー3: 音楽を聴く

**背景**: ユーザーCarolは、ログで紹介されているアーティストの曲を聴きたい。

**アクション**:
1. タグ「YOASOBI」の詳細ページを開く
2. 「🔗 関連リンク」セクションで「🎵 Spotify」をクリック
3. Spotifyアプリで曲を再生

**結果**: Carolは好みのストリーミングサービスで即座に音楽を楽しめた。

## 機能要件

### 必須要件 (Phase 1)

| ID | 要件 | 説明 |
|----|------|------|
| FR-001 | タグのメタデータ拡張 | タグの`metadata.links`フィールドに外部リンクを保存 |
| FR-002 | リンクタイプの定義 | 公式サイト、Wikipedia、購入サイト、ストリーミング等の標準リンクタイプ |
| FR-003 | カスタムリンク | ユーザー定義のカスタムリンクをサポート |
| FR-004 | タグ詳細ページ表示 | タグ詳細ページに「🔗 関連リンク」セクションを表示 |
| FR-005 | ログ詳細ページ表示 | ログに紐づくタグのリンクを集約して表示 |
| FR-006 | リンクアイコン | 各リンクタイプに対応するアイコン（emoji）を表示 |
| FR-007 | 外部リンク | すべてのリンクは新しいタブで開く |
| FR-008 | URLバリデーション | 不正なURL形式や危険なスキームを拒否 |

### 任意要件 (Phase 2)

| ID | 要件 | 説明 |
|----|------|------|
| FR-101 | タグ編集フォーム | UIからリンクを追加・編集できるフォーム |
| FR-102 | ログのメタデータ | ログテーブルに`metadata`カラムを追加し、ログ固有のリンクをサポート |
| FR-103 | リンクプレビュー | Open Graph APIを使用してリンクのサムネイルとタイトルを表示 |
| FR-104 | リンク分析 | リンクのクリック数を記録し、人気のリンクを表示 |
| FR-105 | 自動リンク生成 | タグ名から自動的にWikipedia URLを生成 |
| FR-106 | サービスアイコン | 各サービスの公式アイコンを使用（ライセンス許可の範囲内） |

## 非機能要件

| ID | 要件 | 説明 |
|----|------|------|
| NFR-001 | セキュリティ | XSS攻撃を防ぐため、`javascript:`等の危険なスキームを拒否 |
| NFR-002 | パフォーマンス | リンク表示はページ読み込み時間に影響を与えない |
| NFR-003 | レスポンシブ | モバイル、タブレット、デスクトップで適切に表示 |
| NFR-004 | アクセシビリティ | スクリーンリーダーでリンクが適切に読み上げられる |
| NFR-005 | 互換性 | 既存のAPIとデータモデルとの互換性を維持 |
| NFR-006 | 拡張性 | 新しいリンクタイプの追加が容易 |

## データ構造

### タグメタデータ (metadata.links)

```typescript
interface TagLinks {
  // 公式・情報サイト
  official?: string;
  wikipedia?: string;
  wikidataId?: string;
  
  // 購入サイト
  amazon?: string;
  rakuten?: string;
  
  // ストリーミング（動画）
  netflix?: string;
  amazonPrime?: string;
  crunchyroll?: string;
  
  // ストリーミング（音楽）
  spotify?: string;
  appleMusic?: string;
  youtube?: string;
  
  // ゲームストア
  steam?: string;
  nintendoEshop?: string;
  playstationStore?: string;
  
  // コミュニティ・データベース
  myanimelist?: string;
  anilist?: string;
  
  // カスタムリンク
  custom?: Array<{
    name: string;
    url: string;
    icon?: string;
  }>;
}
```

## UI設計

### タグ詳細ページ

```
┌────────────────────────────────────────────┐
│ Attack on Titan                            │
├────────────────────────────────────────────┤
│ 📝 説明                                     │
│ 人気のアニメ・マンガシリーズ #Anime #Shonen │
├────────────────────────────────────────────┤
│ 🔗 関連リンク                               │
│ [🌐 公式サイト] [📖 Wikipedia]              │
│ [📊 MyAnimeList] [📺 Crunchyroll]          │
│ [📺 Netflix] [🛒 Amazon]                   │
├────────────────────────────────────────────┤
│ ℹ️ 情報                                     │
│ 📊 使用回数: 5 回                           │
│ ...                                        │
└────────────────────────────────────────────┘
```

### ログ詳細ページ

```
┌────────────────────────────────────────────┐
│ 進撃の巨人 最終話を見た                      │
├────────────────────────────────────────────┤
│ [ログ本文]                                  │
├────────────────────────────────────────────┤
│ 🏷️ タグ                                     │
│ #Anime  #AttackOnTitan  #Shonen            │
├────────────────────────────────────────────┤
│ 🔗 関連リンク（タグから）                    │
│                                            │
│ Attack on Titan:                           │
│ [🌐 公式サイト] [📖 Wikipedia]              │
│ [📺 Crunchyroll] [📺 Netflix]              │
│                                            │
│ Anime:                                     │
│ [📖 Wikipedia] [📊 MyAnimeList]            │
└────────────────────────────────────────────┘
```

## API仕様

### タグ作成・更新

既存のタグAPIを使用（`/api/tags`、`/api/tags/{tagId}`）。メタデータにリンク情報を含める。

**リクエスト例**:

```json
POST /api/tags
{
  "name": "Demon Slayer",
  "description": "人気のアニメ・マンガシリーズ",
  "metadata": {
    "category": "anime",
    "year": 2019,
    "links": {
      "official": "https://kimetsu.com/",
      "wikipedia": "https://ja.wikipedia.org/wiki/鬼滅の刃",
      "myanimelist": "https://myanimelist.net/anime/38000/",
      "netflix": "https://www.netflix.com/title/81091393"
    }
  }
}
```

**レスポンス**: 標準のタグオブジェクト（`metadata`を含む）

## セキュリティ

### URL検証

1. **スキーム制限**: `http:`と`https:`のみ許可
2. **危険なスキーム拒否**: `javascript:`, `data:`, `vbscript:`等を拒否
3. **外部リンク属性**: `rel="noopener noreferrer"`を付与
4. **新しいタブで開く**: `target="_blank"`を使用

### XSS対策

- URLはすべてバリデーションを通過したもののみ表示
- リンクテキストはエスケープ処理

## 実装計画

### Phase 1: 基本実装（2週間）

1. **Week 1**:
   - ✅ 設計ドキュメント完成
   - シードデータにリンク追加
   - `ContentLinks.tsx`コンポーネント実装
   - URLバリデーション実装

2. **Week 2**:
   - タグ詳細ページ統合
   - ログ詳細ページ統合
   - テスト作成
   - ドキュメント更新

### Phase 2: 拡張機能（将来）

- タグ編集フォームの改善
- ログのメタデータ対応
- リンクプレビュー機能
- 自動リンク生成

## 成功指標

### KPI

1. **リンク利用率**: タグにリンクが追加されている割合（目標: 50%）
2. **クリック率**: リンクがクリックされる割合（Phase 2で測定）
3. **ユーザー満足度**: リンク機能に対するフィードバック
4. **カバレッジ**: 主要なコンテンツタイプ（アニメ、ゲーム、音楽、マンガ）へのリンク提供率

### 検証方法

1. **ユーザビリティテスト**: 5人のユーザーに機能を使用してもらい、フィードバックを収集
2. **A/Bテスト**: リンクがあるタグとないタグでエンゲージメントを比較（Phase 2）
3. **アクセス解析**: リンククリック数の追跡（Phase 2）

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 不正なURLによるフィッシング | 高 | URLバリデーションの徹底、外部リンク警告 |
| リンク切れ | 中 | 将来的にリンクチェック機能を実装 |
| パフォーマンス低下 | 低 | リンク数に制限を設ける（推奨: 10個まで） |
| 著作権問題 | 低 | 公式サイトと公共データベースのみリンク |

## 関連ドキュメント

- [詳細設計書](./design.md) - 詳細な設計情報
- [データモデル](./data-model.md) - メタデータの構造詳細
- [調査・研究](./research.md) - 技術的な調査結果
- [クイックスタート](./quickstart.md) - 使用方法とサンプル
- [OpenAPI仕様](../../api/v1/openapi.yaml) - API仕様書

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-10-12 | 1.0.0 | 初版作成 |

## 承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| 設計者 | GitHub Copilot | 2025-10-12 |
| レビュアー | - | - |

---

**次のステップ**: この仕様書に基づいて、Phase 1の実装を開始します。
